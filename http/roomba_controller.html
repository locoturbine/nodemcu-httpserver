<!DOCTYPE html>
<html>
   <head>
      <link rel="stylesheet" type="text/css" href="roomba_controller.css">
 
      <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
      <meta charset="UTF-8">
      <title>Roomba Controller!!!</title>
   </head>
   <script>
      var xmlHttp = null;
    const START   =  128;  // 0
    const BAUD    =  129;  // 1
    const CONTROL =  130;  // 0
    const SAFE    =  131;  // 0
    const FULL    =  132;  // 0
    const POWER   =  133;  // 0
    const SPOT    =  134;  // 0
    const CLEAN   =  135;  // 0
    const MAX     =  136;  // 0
    const DRIVE   =  137;  // 4
    const MOTORS  =  138;  // 1
    const LEDS    =  139;  // 3
    const SONG    =  140;  // 2N+2
    const PLAY    =  141;  // 1
    const SENSORS =  142;  // 1
    const DOCK    =  143;  // 0
    const PWMMOTORS = 144; // 3
    const DRIVEWHEELS = 145; 	// 4
    const DRIVEPWM = 146;  // 4
    const STREAM  =  148;  // N+1
    const QUERYLIST = 149; // N+1
    const STOPSTARTSTREAM = 150;  // 1
    const SCHEDULINGLEDS = 162; 	// 2
    const DIGITLEDSRAW = 163; 	// 4
    const DIGITLEDSASCII = 164;	// 4
    const BUTTONSCMD  =  165; // 1
    const SCHEDULE =  167;  // n
    const SETDAYTIME = 168; // 3

	   const DEFAULT_SPEED = 200

      function sendCommand(command)
      {
         var url = "/roomba_controller.lua?command=" + command;
		 console.log("URL: " +url);
         xmlHttp = new XMLHttpRequest();
         xmlHttp.onreadystatechange = processRequest;
         xmlHttp.open("GET", url, true);
         xmlHttp.send( null );
      }
	
	function drive( velocity, radius ) {
	
		var cmd32bit = [ DRIVE,(velocity>>>8),(velocity&0xff), 
			       (radius >>> 8), (radius & 0xff) ];
		var cmd = new Uint8Array(cmd32bit);
		console.log("cmd 8-bit: " + cmd);	
		sendCommand( cmd );
	}
	   
	   
	function goStraightAt( velocity ) {
       
        if( velocity > 500 ) velocity = 500;
        if( velocity < -500 ) velocity = -500;
        drive( velocity, 0x8000 );
    }
	function goStraight()
      {
	goStraightAt(500);
         
      }
	function goBackwards()
      {
	goStraightAt(-500);
         
      }	   
	   
	function sendDrive(direction) {
	 if (direction = 'FORWARD') 
		 goStraight();
	 elseif (direction = 'BACKWARD') 
		goBackwards();
		
	}

      function processRequest()
      {
         if(xmlHttp.readyState == 0)
         {
            document.getElementById("label").innerHTML = 'Initalizing...';
            document.getElementById("label").className = "initalizing";
         }
         else if(xmlHttp.readyState == 1)
         {
            document.getElementById("label").innerHTML = 'Server connection established.';
            document.getElementById("label").className = "connection";
         }
         else if(xmlHttp.readyState == 2)
         {
            document.getElementById("label").innerHTML = 'Request received.';
            document.getElementById("label").className = "received";
         }
         else if(xmlHttp.readyState == 3)
         {
            document.getElementById("label").innerHTML = 'Processing request.';
            document.getElementById("label").className = "processing";
         }
         else if(xmlHttp.readyState == 4)
         {
            if(xmlHttp.status == 200)
            {
               document.getElementById("label").innerHTML = xmlHttp.responseText;
               document.getElementById("label").className = "ok";
               sleep(300);
               document.getElementById("label").className = "start";
            }
            else if(xmlHttp.status == 400)
            {
               document.getElementById("label").innerHTML = 'Bad request.';
               document.getElementById("label").className = "bad";
            }
         }
      }
      function sleep(milliseconds){
         var start = new Date().getTime();
         for (var i = 0; i < 1e7; i++)
         {
            if ((new Date().getTime() - start) > milliseconds)
            {
               break;
            }
         }
      }
   </script>
   <body bgcolor="#777777">
   <div id="remote">
      <div id="label" class="start"></div>
      <a href="#" onclick="sendCommand('CLEAN'); " class="button button-1">
          <span>Clean</span>
      </a>
      <a href="#" onclick="sendCommand('START'); " class="button button-2">
          <span>Stop</span>
      </a>
      <div id="spacer"></div>
      <a href="#" onclick="sendCommand('DOCK'); " class="button button-1">
          <span>Dock</span>
      </a>
      <a href="#" onclick="sendCommand('SPOT'); " class="button button-2">
          <span>Spot</span>
      </a>
       <div id="spacer"></div>
        <a href="#" onclick="sendDrive('FORWARD'); " class="button button-1">
          <span>Up</span>
      </a>
      <a href="#" onclick="sendDrive('BACKWARD'); " class="button button-2">
          <span>Down</span>
      </a> <a href="#" onclick="sendDrive('LEFT'); " class="button button-1">
          <span>Left</span>
      </a>
      <a href="#" onclick="sendDrive('RIGHT'); " class="button button-2">
          <span>Right</span>
      </a>
   </div>
   
   </body>
</html>

